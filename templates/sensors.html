{% extends "base.html" %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-microphone text-primary"></i> Acoustic Sensor Monitoring</h2>

<!-- Stats Row -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card stats-card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-microphone fa-2x mb-2"></i>
                <h3>{{ locations|length }}</h3>
                <small>Active Sensors</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-danger text-white">
            <div class="card-body text-center">
                <i class="fas fa-moon fa-2x mb-2"></i>
                <h3 id="nightCount">0</h3>
                <small>Night Detections</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-volume-up fa-2x mb-2"></i>
                <h3>{{ acoustic_data|length }}</h3>
                <small>Total Detections</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stats-card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x mb-2"></i>
                <h3 id="highConfCount">0</h3>
                <small>High Confidence (&gt;75%)</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Machinery Type Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="machineryChart" height="250"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Detections by Hour</h5>
            </div>
            <div class="card-body">
                <canvas id="hourChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Live Sensor Grid -->
<div class="row mb-4">
    <div class="col-12">
        <h5><i class="fas fa-broadcast-tower text-warning"></i> Sensor Status</h5>
    </div>
    {% for loc in locations %}
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card sensor-card h-100">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-microphone text-success"></i> {{ loc.name }}</span>
                <span class="badge bg-success blink">LIVE</span>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <small class="text-muted">Recent Detections</small>
                    <span class="badge bg-{{ 'danger' if loc.risk_level in ['critical', 'high'] else 'warning' }}">{{
                        loc.risk_level|upper }}</span>
                </div>
                <div class="sensor-visualizer" id="viz_{{ loc.id }}">
                    <div class="sound-wave">
                        <div class="wave-bar" style="height: 20%"></div>
                        <div class="wave-bar" style="height: 45%"></div>
                        <div class="wave-bar" style="height: 70%"></div>
                        <div class="wave-bar" style="height: 90%"></div>
                        <div class="wave-bar" style="height: 60%"></div>
                        <div class="wave-bar" style="height: 80%"></div>
                        <div class="wave-bar" style="height: 40%"></div>
                        <div class="wave-bar" style="height: 55%"></div>
                        <div class="wave-bar" style="height: 30%"></div>
                        <div class="wave-bar" style="height: 65%"></div>
                    </div>
                </div>
                <small class="text-muted d-block mt-2" id="status_{{ loc.id }}">Monitoring...</small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Detections Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> Recent Acoustic Detections</h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block w-auto" id="filterType">
                        <option value="all">All Types</option>
                        <option value="excavator">Excavator</option>
                        <option value="drill">Drill</option>
                        <option value="crusher">Crusher</option>
                        <option value="generator">Generator</option>
                        <option value="truck">Truck</option>
                        <option value="conveyor">Conveyor</option>
                    </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Timestamp</th>
                                <th>Location</th>
                                <th>Type</th>
                                <th>Confidence</th>
                                <th>Duration</th>
                                <th>Frequency</th>
                                <th>Amplitude</th>
                                <th>Night</th>
                            </tr>
                        </thead>
                        <tbody id="detectionsBody">
                            {% for d in acoustic_data %}
                            <tr class="detection-row" data-type="{{ d.detection_type }}">
                                <td><small>{{ d.timestamp }}</small></td>
                                <td>{{ d.location_name }}</td>
                                <td><span class="badge bg-warning text-dark">{{ d.detection_type }}</span></td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-{{ 'danger' if d.confidence > 0.9 else 'warning' if d.confidence > 0.75 else 'info' }}"
                                            style="width: {{ (d.confidence * 100)|round }}%">
                                            {{ (d.confidence * 100)|round }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ d.duration_seconds|round }}s</td>
                                <td>{{ d.frequency_hz|round }} Hz</td>
                                <td>{{ d.amplitude_db|round(1) }} dB</td>
                                <td>
                                    {% if d.is_night_mining %}
                                    <span class="badge bg-danger">ðŸŒ™ YES</span>
                                    {% else %}
                                    <span class="text-muted">No</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    .sound-wave {
        display: flex;
        align-items: flex-end;
        gap: 3px;
        height: 60px;
        padding: 5px;
        background: #1a1a2e;
        border-radius: 5px;
    }

    .wave-bar {
        flex: 1;
        background: linear-gradient(to top, #00ff41, #39ff14);
        border-radius: 2px;
        animation: pulse 0.8s ease-in-out infinite alternate;
    }

    .wave-bar:nth-child(2n) {
        animation-delay: 0.2s;
    }

    .wave-bar:nth-child(3n) {
        animation-delay: 0.4s;
    }

    @keyframes pulse {
        from {
            opacity: 0.4;
        }

        to {
            opacity: 1;
        }
    }
</style>
<script>
    const acousticData = {{ acoustic_data | tojson }};

    // Stats
    const nightCount = acousticData.filter(d => d.is_night_mining).length;
    const highConfCount = acousticData.filter(d => d.confidence > 0.75).length;
    document.getElementById('nightCount').textContent = nightCount;
    document.getElementById('highConfCount').textContent = highConfCount;

    // Machinery Chart
    const typeCounts = {};
    acousticData.forEach(d => { typeCounts[d.detection_type] = (typeCounts[d.detection_type] || 0) + 1; });
    new Chart(document.getElementById('machineryChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(typeCounts),
            datasets: [{
                label: 'Detections',
                data: Object.values(typeCounts),
                backgroundColor: ['#e74c3c', '#f39c12', '#3498db', '#2ecc71', '#9b59b6', '#e67e22'],
                borderRadius: 4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // Hour Distribution Chart
    const hourCounts = new Array(24).fill(0);
    acousticData.forEach(d => {
        const hour = parseInt(d.timestamp.split(' ')[1].split(':')[0]);
        hourCounts[hour]++;
    });
    new Chart(document.getElementById('hourChart'), {
        type: 'bar',
        data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Detections',
                data: hourCounts,
                backgroundColor: hourCounts.map((_, i) => [22, 23, 0, 1, 2, 3, 4, 5].includes(i) ? '#e74c3c' : '#3498db'),
                borderRadius: 2
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });

    // Filter
    document.getElementById('filterType').addEventListener('change', function () {
        const type = this.value;
        document.querySelectorAll('.detection-row').forEach(row => {
            row.style.display = (type === 'all' || row.dataset.type === type) ? '' : 'none';
        });
    });

    // Animate sensor wave bars randomly
    setInterval(() => {
        document.querySelectorAll('.wave-bar').forEach(bar => {
            bar.style.height = (Math.random() * 80 + 10) + '%';
        });
    }, 800);
</script>
{% endblock %}