{% extends "base.html" %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-map text-primary"></i> Aravalli Hills Monitoring Map</h2>

<div class="row">
    <!-- Map -->
    <div class="col-lg-9">
        <div class="card">
            <div class="card-body p-0">
                <div id="map" style="height: 600px; border-radius: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-3">
        <!-- Legend -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Legend</h6>
            </div>
            <div class="card-body py-2">
                <div class="d-flex align-items-center mb-1"><span class="legend-dot bg-danger"></span> Critical Risk
                </div>
                <div class="d-flex align-items-center mb-1"><span class="legend-dot bg-warning"></span> High Risk</div>
                <div class="d-flex align-items-center mb-1"><span class="legend-dot" style="background:#f39c12"></span>
                    Medium Risk</div>
                <div class="d-flex align-items-center mb-1"><span class="legend-dot bg-success"></span> Low Risk</div>
                <hr class="my-2">
                <div class="d-flex align-items-center mb-1"><span class="legend-dot bg-dark"></span> Illegal Mining Site
                </div>
                <div class="d-flex align-items-center mb-1"><span class="legend-dot" style="background:#17a2b8"></span>
                    GPS Checkpoint</div>
                <div class="d-flex align-items-center"><span class="legend-dot" style="background:#6f42c1"></span> RFID
                    Gate</div>
            </div>
        </div>

        <!-- Location List -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Locations</h6>
            </div>
            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
                <div class="list-group list-group-flush">
                    {% for loc in locations %}
                    <a href="#" class="list-group-item list-group-item-action py-2"
                        onclick="flyToLocation({{ loc.lat }}, {{ loc.lon }}, '{{ loc.name }}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <small>{{ loc.name }}</small>
                            <span
                                class="badge bg-{{ 'danger' if loc.risk_level == 'critical' else 'warning' if loc.risk_level == 'high' else 'info' if loc.risk_level == 'medium' else 'success' }}">
                                {{ loc.risk_level|upper }}
                            </span>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Analysis Panel -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <button class="btn btn-danger btn-sm w-100 mb-2" onclick="showMiningOnly()">
                    <i class="fas fa-exclamation-triangle"></i> Show Mining Sites
                </button>
                <button class="btn btn-info btn-sm w-100 mb-2" onclick="showCheckpoints()">
                    <i class="fas fa-map-pin"></i> Show Checkpoints
                </button>
                <button class="btn btn-primary btn-sm w-100" onclick="resetMap()">
                    <i class="fas fa-undo"></i> Reset View
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
        flex-shrink: 0;
    }
</style>
<script>
    // Initialize map centered on Aravalli range
    var map = L.map('map').setView([27.0, 76.0], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var markers = [];
    var miningMarkers = [];
    var checkpointMarkers = [];

    // Add monitoring locations
    {% for loc in locations %}
    (function () {
        var color = '{{ "red" if loc.risk_level == "critical" else "orangered" if loc.risk_level == "high" else "orange" if loc.risk_level == "medium" else "green" }}';
        var marker = L.circleMarker([{{ loc.lat }}, {{ loc.lon }}], {
        radius: { { 12 if loc.risk_level in ['critical', 'high'] else 8 } },
        fillColor: color,
            color: '#fff',
                weight: 2,
                    opacity: 1,
                        fillOpacity: 0.85
    }).addTo(map);

    marker.bindPopup(`
        <div style="min-width: 200px;">
            <h6><i class="fas fa-map-marker-alt"></i> {{ loc.name }}</h6>
            <p class="mb-1"><strong>State:</strong> {{ loc.state }}</p>
            <p class="mb-1"><strong>Risk:</strong> <span class="badge" style="background:${color};">{{ loc.risk_level|upper }}</span></p>
            <p class="mb-1"><strong>Activity:</strong> {{ loc.mining_activity }}</p>
            <p class="mb-1 small">{{ loc.description }}</p>
            <div class="mt-2">
                <i class="fas fa-video {{ 'text-success' if loc.camera_installed else 'text-muted' }}"></i> Camera
                <i class="fas fa-microphone ms-2 {{ 'text-success' if loc.acoustic_sensor else 'text-muted' }}"></i> Sensor
            </div>
            {% if loc.last_incident %}
            <p class="mt-1 mb-0"><small class="text-danger">Last incident: {{ loc.last_incident }}</small></p>
            {% endif %}
        </div>
    `);
    markers.push(marker);
}) ();
    {% endfor %}

    // Add mining sites
    {% for site in mining_sites %}
    (function () {
        var icon = L.divIcon({
            className: 'custom-div-icon',
            html: '<div style="background-color: #000; color: #ff0; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid #ff0;">‚ö†</div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        var marker = L.marker([{{ site.lat }}, {{ site.lon }}], { icon: icon }).addTo(map);
    marker.bindPopup(`
        <div style="min-width: 200px;">
            <h6 class="text-danger"><i class="fas fa-exclamation-triangle"></i> {{ site.name }}</h6>
            <p class="mb-1"><strong>Type:</strong> {{ site.type }}</p>
            <p class="mb-1"><strong>Size:</strong> {{ site.size }}</p>
            <p class="mb-1"><strong>Discovered:</strong> {{ site.discovered }}</p>
            <p class="mb-1 small">{{ site.description }}</p>
            <p class="mb-0">Night activity: {{ 'üåô Yes' if site.night_activity else 'No' }}</p>
        </div>
    `);
    miningMarkers.push(marker);
}) ();
    {% endfor %}

    // Add GPS checkpoints
    {% for cp in gps_checkpoints %}
    (function () {
        var icon = L.divIcon({
            className: 'custom-div-icon',
            html: '<div style="background-color: #17a2b8; color: #fff; width: 20px; height: 20px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px;">üìç</div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        var marker = L.marker([{{ cp.lat }}, {{ cp.lon }}], { icon: icon }).addTo(map);
    marker.bindPopup('<strong>Checkpoint:</strong> {{ cp.name }}');
    checkpointMarkers.push(marker);
}) ();
    {% endfor %}

    // Add RFID gates
    {% for gate in rfid_gates %}
    (function () {
        var icon = L.divIcon({
            className: 'custom-div-icon',
            html: '<div style="background-color: #6f42c1; color: #fff; width: 20px; height: 20px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px;">üì°</div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        var marker = L.marker([{{ gate.lat }}, {{ gate.lon }}], { icon: icon }).addTo(map);
    marker.bindPopup('<strong>RFID Gate:</strong> {{ gate.location }}');
    checkpointMarkers.push(marker);
}) ();
    {% endfor %}

    function flyToLocation(lat, lon, name) {
        map.flyTo([lat, lon], 12, { duration: 1.5 });
    }

    function showMiningOnly() {
        markers.forEach(m => map.removeLayer(m));
        checkpointMarkers.forEach(m => map.removeLayer(m));
        miningMarkers.forEach(m => map.addLayer(m));
    }

    function showCheckpoints() {
        markers.forEach(m => map.addLayer(m));
        miningMarkers.forEach(m => map.addLayer(m));
        checkpointMarkers.forEach(m => map.addLayer(m));
    }

    function resetMap() {
        markers.forEach(m => map.addLayer(m));
        miningMarkers.forEach(m => map.addLayer(m));
        checkpointMarkers.forEach(m => map.addLayer(m));
        map.setView([27.0, 76.0], 7);
    }

    // Open to specific location if URL param
    const params = new URLSearchParams(window.location.search);
    if (params.get('loc')) {
        fetch(`/api/location/${params.get('loc')}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    flyToLocation(data.location.lat, data.location.lon, data.location.name);
                }
            });
    }
</script>
{% endblock %}